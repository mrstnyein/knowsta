<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowsta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="https://i.ibb.co/hRdf1MRq/knowsta.png" />
    
    <!-- SEO and Open Graph Tags -->
    <meta name="description" content="Knowsta AI: The smart conversational assistant powered by Gemini. Fast, accurate, and multilingual chat."/>
    <meta property="og:title" content="Knowsta AI Assistant"/>
    <meta property="og:description" content="The fast, modern, and multilingual AI chat app powered by Google Gemini."/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://placehold.co/1200x630/004aad/ffffff?text=Knowsta+AI"/>
    <meta property="og:url" content="[Your App URL]"/> 

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Primary Brand Color: #004aad (Deep Blue) */
        
        /* Base Styles and Layout (Dual Panel) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; 
            transition: background-color 0.3s;
        }
        .app-container {
            max-width: 1400px; /* Wider for web */
            height: 95vh;
            margin: 2.5vh auto;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            background-color: white;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        /* Sidebar Styles (Desktop Only) */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background-color: #f7fafc;
            border-right: 1px solid #e2e8f0;
            display: flex; /* Always visible on desktop */
            flex-direction: column;
            transition: all 0.3s;
        }
        
        /* Main Chat Panel */
        .main-chat-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Mobile Layout */
        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                margin: 0;
                border-radius: 0;
            }
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 40;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                box-shadow: 0 0 20px rgba(0,0,0,0.2);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            /* Adjust main chat panel to take full width */
            .main-chat-panel {
                width: 100%;
            }
        }
        
        /* Chat Bubbles: UNIFIED USER BUBBLE COLOR */
        .chat-bubble-user {
            background-color: #004aad; /* Cohesive with primary button color */
            color: white;
            border-radius: 18px 18px 2px 18px;
            padding: 10px 14px;
            max-width: 90%; 
        }
        .chat-bubble-ai {
            background-color: #e5e5ea; 
            color: #1c1c1e;
            border-radius: 18px 18px 18px 2px;
            padding: 10px 14px;
            max-width: 90%;
        }

        /* Input Bar (Gemini/ChatGPT style) */
        .input-bar-wrapper {
            transition: box-shadow 0.2s, background-color 0.3s;
            box-shadow: 0 0 0 1px #e2e8f0, 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        /* Increased focus clarity - using new primary color */
        .input-bar-wrapper:focus-within {
            box-shadow: 0 0 0 1px #004aad, 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 0 0 4px rgba(0, 74, 173, 0.3);
        }
        
        /* --- PRELOADER STYLES (FIXED COLORING) --- */
        #preloader {
            background-color: #f0f2f5; /* Light mode default */
        }
        .dark #preloader {
            background-color: #1c1c1e; /* Dark mode background */
        }
        .dark #preloader .loading-dots span {
            background-color: #004aad; /* Primary color */
        }
        /* Preloader bounce animation (unique for preloader) */
        #preloader .loading-dots span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        #preloader .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        #preloader .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        #preloader .loading-dots span:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* --- TYPING INDICATOR & CURSOR STYLES --- */
        .typing-dots-animation span {
            animation: typing-bounce 1.4s infinite ease-in-out both;
            background-color: #004aad; /* Primary blue for dots */
        }
        .typing-dots-animation span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots-animation span:nth-child(2) { animation-delay: -0.16s; }
        .typing-dots-animation span:nth-child(3) { animation-delay: 0s; }
        @keyframes typing-bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: #004aad; /* Main app color */
            animation: blink 1s step-end infinite;
            vertical-align: bottom;
            margin-left: 2px;
        }
        .dark .typing-cursor {
            background-color: #5599ff; /* A lighter blue for dark mode contrast */
        }
        @keyframes blink {
            from, to { opacity: 1; }
            50% { opacity: 0; }
        }

        /* --- CODE BLOCK STYLES (NEW FIX) --- */
        pre {
            background-color: #f3f4f6; /* Light gray background */
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto; /* Allow horizontal scrolling for long lines */
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem; /* 14px */
            position: relative;
            margin: 1em 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .dark pre {
            background-color: #1f2937; /* Darker gray for dark mode */
            border-color: #374151;
            color: #d1d5db;
        }

        .copy-code-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #d1d5db;
            border: none;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: #4b5563;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, background-color 0.2s;
        }

        pre:hover .copy-code-btn {
            opacity: 1;
        }

        .copy-code-btn:hover {
            background-color: #9ca3af;
            color: #1f2937;
        }

        .dark .copy-code-btn {
            background-color: #4b5563;
            color: #d1d5db;
        }

        .dark .copy-code-btn:hover {
            background-color: #6b7280;
            color: white;
        }


        /* --- DARK MODE STYLES --- */
        .dark body { background-color: #1c1c1e; }
        .dark .app-container { background-color: #2c2c2e; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); }
        /* Refined dark sidebar color for better contrast */
        .dark .sidebar { background-color: #1f1f1f; border-right: 1px solid #3a3a3c; color: white; }
        .dark .chat-bubble-ai { background-color: #48484a; color: white; }
        /* FIX: Ensure user input text is clearly visible */
        .dark #user-input { color: white; }
        /* FIX: Dark mode input border visibility - increased contrast */
        .dark .input-bar-wrapper { 
            background-color: #3a3a3c; 
            border-color: #555555; /* Adjusted for better visibility */
        }
        .dark .input-bar-wrapper:focus-within {
            box-shadow: 0 0 0 1px #004aad, 0 1px 3px 0 rgba(0, 0, 0, 0.4), 0 0 0 4px rgba(0, 74, 173, 0.3);
        }
        .dark header { background-color: rgba(44, 44, 46, 0.9); border-color: #3a3a3c; }
        .dark .topic-item { background-color: #3a3a3c; color: #e5e5ea; }
        /* Sidebar text readability fix */
        .dark .sidebar .text-gray-700 { color: #f0f2f5; }
        .dark .sidebar .text-gray-300 { color: #a2a2a7; }
        .dark .sidebar .animated-button { color: #f0f2f5; } /* Ensures buttons are visible */
        .dark .sidebar .hover\:bg-gray-200:hover { background-color: #3a3a3c; }
        /* Sidebar utility buttons dark mode base state */
        .dark .sidebar .utility-button {
            background-color: #3a3a3c;
            color: white;
            box-shadow: none;
        }

        /* --- LIGHT MODE SIDEBAR BUTTON STYLING (The requested color fix) --- */
        .sidebar .utility-button {
            /* Background changed from old gray/transparent to a subtle blue tone */
            background-color: #E6F0FF; 
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            /* Ensure primary color is visible and sharp */
            color: #004aad; 
            box-shadow: 0 1px 3px 0 rgba(0, 74, 173, 0.1); /* Subtle blue shadow for lift */
        }
        .sidebar .utility-button:hover {
            background-color: #d8e5ff; /* Slightly darker blue on hover */
            color: #004aad;
            box-shadow: 0 2px 5px 0 rgba(0, 74, 173, 0.2); 
        }

        /* Scrollbar and Animations remain the same */
        #chat-window::-webkit-scrollbar, #chat-history-list::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-thumb, #chat-history-list::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .animated-button:active { transform: scale(0.95); }

        /* FIX: Ensure typed text is visible in light mode input */
        #user-input { color: #1c1c1e; }
        
        /* Timestamps (Small and subtle) */
        .timestamp {
            font-size: 0.6rem;
            opacity: 0.6;
            margin-top: 2px;
            user-select: none;
        }
        .user-message-wrapper .timestamp {
            margin-right: 16px;
        }
        .ai-message-wrapper .timestamp {
            margin-left: 16px;
        }
        
        /* FIX: Logo color in light mode header */
        .main-chat-panel header h1 {
            color: #004aad; /* New primary color */
        }
        .dark .main-chat-panel header h1 {
            color: white; 
        }
        
        /* Button primary color update */
        #new-chat-button, #send-button, #auth-button.bg-indigo-600, 
        #settings-modal .bg-indigo-600, #about-modal .bg-indigo-600, #profile-modal .bg-indigo-600 {
            background-color: #004aad;
        }
        #new-chat-button:hover, #send-button:hover, #auth-button.bg-indigo-600:hover,
        #settings-modal .bg-indigo-600:hover, #about-modal .bg-indigo-600:hover, #profile-modal .bg-indigo-600:hover {
            background-color: #003a89;
        }
        
        /* Message Controls (Edit/Regenerate/Delete/Copy/Listen) */
        .message-controls { opacity: 0; transition: opacity 0.2s; }
        .user-message-wrapper:hover .message-controls,
        .ai-message-wrapper:hover .message-controls { opacity: 1; }

        /* Chat History List Styles */
        #chat-history-list .chat-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 8px; /* Rounded corners for history items */
        }
        #chat-history-list .chat-history-item .chat-title {
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            flex-grow: 1;
            padding: 8px; /* Add padding to the clickable area */
        }

        #chat-history-list .chat-history-item.active {
            background-color: #e6f0ff;
            color: #004aad;
            font-weight: 600;
        }
        .dark #chat-history-list .chat-history-item.active {
            background-color: #3a3a3c;
        }

        #chat-history-list .chat-history-item .delete-chat-btn {
            opacity: 0;
            transition: opacity 0.2s;
            flex-shrink: 0;
            padding: 6px;
            border-radius: 50%;
        }
        #chat-history-list .chat-history-item:hover .delete-chat-btn {
            opacity: 1;
        }
        #chat-history-list .chat-history-item .delete-chat-btn:hover {
            background-color: #fee2e2;
            color: #ef4444;
        }
        .dark #chat-history-list .chat-history-item .delete-chat-btn:hover {
            background-color: #4b1f20;
            color: #f87171;
        }

        /* Modal Transitions */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
            opacity: 0;
        }

        /* NEW: Active Persona Button Style */
        .sidebar .utility-button.active-persona {
            background-color: #cce0ff;
            color: #004aad;
            font-weight: 600;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        .dark .sidebar .utility-button.active-persona {
            background-color: #004aad;
            color: white;
        }
    </style>
</head>
<body class="p-0 sm:p-4">
    <!-- PRELOADER -->
    <div id="preloader" class="fixed inset-0 flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="flex flex-col items-center">
            <img src="https://i.ibb.co/hRdf1MRq/knowsta.png" alt="Knowsta Logo" class="w-12 h-12 mb-4 animate-bounce rounded-full">
            <div class="loading-dots flex justify-center space-x-1">
                <span class="w-3 h-3 bg-[#004aad] rounded-full"></span>
                <span class="w-3 h-3 bg-[#004aad] rounded-full"></span>
                <span class="w-3 h-3 bg-[#004aad] rounded-full"></span>
            </div>
            <p id="preloader-text" class="mt-4 text-gray-700 dark:text-gray-300">Loading Knowsta...</p>
        </div>
    </div>
    
    <div id="app" class="app-container opacity-0">

        <!-- --- SIDEBAR (Desktop Navigation) --- -->
        <div class="sidebar p-4 pt-6 flex flex-col">
            
            <!-- Logo & New Chat -->
            <div class="flex-shrink-0">
                <div class="flex items-center justify-center mb-6">
                    <img src="https://i.ibb.co/hRdf1MRq/knowsta.png" alt="Knowsta Logo" class="w-8 h-8 rounded-full">
                </div>
                <button id="new-chat-button" onclick="knowstaApp.methods.resetToGeneralChat()" class="w-full py-2 px-3 text-base rounded-xl bg-indigo-600 text-white transition duration-150 hover:bg-indigo-700 animated-button shadow-md mb-6">
                    <div class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        <span id="label-new-chat">New Chat</span>
                    </div>
                </button>
            </div>

            <!-- Chat History (NEW) -->
            <div id="chat-history-container" class="flex-grow overflow-y-auto mb-4 border-t border-b border-gray-200 dark:border-gray-700 py-4">
                 <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2 px-1">Recent Chats</div>
                 <div id="chat-history-list" class="space-y-1">
                      <!-- History items will be injected here -->
                 </div>
            </div>

            <!-- Utility Buttons -->
            <div class="space-y-3 flex-shrink-0">
                <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">Settings & Tools</div>
                <button id="settings-button" onclick="knowstaApp.methods.showSettingsModal()" class="utility-button w-full flex items-center p-2 rounded-xl text-sm font-medium dark:bg-gray-800/50 dark:hover:bg-gray-700 animated-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.942 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.942 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.942-1.543.82-3.31 2.37-2.37h.001c.43.723 1.055 1.096 1.761 1.096z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span id="label-settings">Settings</span>
                </button>
                
                <!-- Personas Section -->
                <div id="personas-section" class="pt-2">
                    <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-2">Personas</div>
                    <div id="persona-buttons" class="space-y-1">
                        <button id="persona-general" onclick="knowstaApp.methods.setPersona('general')" class="utility-button persona-button w-full flex items-center p-2 rounded-xl text-sm font-medium active-persona">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                            <span>General</span>
                        </button>
                        <button id="persona-marketing" onclick="knowstaApp.methods.setPersona('marketing')" class="utility-button persona-button w-full flex items-center p-2 rounded-xl text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                            <span>Marketing</span>
                        </button>
                        <button id="persona-learn" onclick="knowstaApp.methods.setPersona('learn')" class="utility-button persona-button w-full flex items-center p-2 rounded-xl text-sm font-medium">
                             <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                            <span>Learn</span>
                        </button>
                        <button id="persona-coding" onclick="knowstaApp.methods.setPersona('coding')" class="utility-button persona-button w-full flex items-center p-2 rounded-xl text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                            </svg>
                            <span>Coding</span>
                        </button>
                    </div>
                </div>

                <button id="export-button" onclick="knowstaApp.methods.exportChat()" class="utility-button w-full flex items-center p-2 rounded-xl text-sm font-medium dark:bg-gray-800/50 dark:hover:bg-gray-700 animated-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    <span id="label-export">Export Conversation (.txt)</span>
                </button>
            </div>

            <!-- Profile and About Footer -->
            <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700 space-y-2 flex-shrink-0">
                <button id="sidebar-auth-btn" onclick="knowstaApp.methods.handleAuthClickOrProfile()" class="utility-button w-full flex items-center p-2 rounded-xl text-sm font-medium dark:bg-gray-800/50 dark:hover:bg-gray-700 animated-button">
                    <img id="user-avatar-sidebar" src="https://placehold.co/32x32/cccccc/ffffff?text=U" alt="User" class="w-8 h-8 rounded-full mr-3">
                    <span id="sidebar-username">Sign In / Profile</span>
                </button>
                <button id="about-btn" onclick="knowstaApp.methods.showAboutModal()" class="utility-button w-full flex items-center p-2 rounded-xl text-sm font-medium dark:bg-gray-800/50 dark:hover:bg-gray-700 animated-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span id="label-about">About Knowsta</span>
                </button>
            </div>
        </div>

        <!-- --- MAIN CHAT PANEL --- -->
        <div class="main-chat-panel">
            
            <!-- Header (Mobile/Web) -->
            <header class="p-2 sm:p-4 border-b border-gray-100 shadow-sm sticky top-0 z-10 flex items-center justify-between transition duration-300">
                <div class="flex items-center gap-2">
                    <button id="hamburger-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 md:hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold transition duration-300 text-[#004aad] dark:text-white">Knowsta</h1>
                </div>
                <!-- Mobile/Web Auth/Profile button -->
                <div class="flex items-center space-x-3">
                    <button id="auth-button" onclick="knowstaApp.methods.handleAuthClick()" class="py-1 px-3 text-sm rounded-full transition duration-150 animated-button">
                        Initializing...
                    </button>
                    <img 
                        id="user-avatar" 
                        src="https://placehold.co/32x32/cccccc/ffffff?text=U" 
                        alt="User Avatar" 
                        class="w-8 h-8 rounded-full hidden cursor-pointer border-2 border-[#004aad] shadow-md transition duration-150 animated-button" 
                        onclick="knowstaApp.methods.showProfileModal()">
                </div>
            </header>

            <!-- Chat Window -->
            <div id="chat-window" class="flex-grow p-2 sm:p-4 space-y-4 overflow-y-auto">
                <!-- Content will be injected here -->
            </div>

            <!-- Input Area -->
            <div class="p-2 sm:p-4 border-t border-gray-100 bg-white transition duration-300">
                <!-- Loading Indicator (Typing Dots UX) -->
                <div id="loading-indicator" class="hidden flex-col items-center text-sm text-[#004aad] mb-2">
                    <div class="flex items-center">
                        <p id="loading-message" class="mt-1 font-semibold text-gray-700 dark:text-gray-300"></p>
                        <div id="typing-dots" class="flex justify-center space-x-1 mt-1 typing-dots-animation ml-2">
                            <span class="w-2 h-2 rounded-full"></span>
                            <span class="w-2 h-2 rounded-full"></span>
                            <span class="w-2 h-2 rounded-full"></span>
                        </div>
                    </div>
                     <!-- NEW: Stop Generation Button -->
                    <button id="stop-generating-btn" onclick="knowstaApp.methods.stopGeneration()" class="hidden mt-2 mx-auto py-1 px-3 text-xs bg-red-100 text-red-700 rounded-full hover:bg-red-200 animated-button">
                        Stop Generating
                    </button>
                </div>
                
                <!-- NEW: Attachment Preview Area -->
                <div id="attachment-preview" class="hidden mb-2 p-2 border border-gray-200 dark:border-gray-700 rounded-lg relative">
                    <!-- Preview content will be injected here -->
                </div>


                <!-- COHESIVE INPUT BAR -->
                <div class="flex items-end gap-1 p-1 border border-gray-300 rounded-2xl input-bar-wrapper">
                    
                    <!-- NEW: Attachment Button -->
                    <button
                        id="attachment-button"
                        onclick="document.getElementById('file-input').click()"
                        class="p-2 text-gray-500 rounded-xl flex items-center justify-center hover:text-[#004aad] transition duration-150 dark:text-gray-300 dark:hover:text-white animated-button"
                        title="Attach File or Image">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a3 3 0 10-6 0v4a1 1 0 102 0V7a1 1 0 112 0v4a3 3 0 11-6 0V7a5 5 0 0110 0v4a5 5 0 01-10 0V7a3 3 0 00-3-3z" clip-rule="evenodd" />
                        </svg>
                    </button>


                    <!-- Voice Input Button (Smaller, contained) -->
                    <button
                        id="mic-button"
                        onclick="knowstaApp.methods.toggleVoiceInput()"
                        class="p-2 text-gray-500 rounded-xl flex items-center justify-center hover:text-[#004aad] transition duration-150 dark:text-gray-300 dark:hover:text-white animated-button"
                        title="Start Voice Input"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7v0a7 7 0 01-7-7v0M12 19v3M12 4v12M12 4a3 3 0 00-3 3v5a3 3 0 006 0V7a3 3 0 00-3-3z" />
                        </svg>
                    </button>

                    <textarea
                        id="user-input"
                        rows="1"
                        placeholder="Ask anything..."
                        class="flex-grow p-1 bg-transparent resize-none focus:ring-0 focus:border-transparent outline-none transition duration-150 dark:text-white"
                        oninput="knowstaApp.methods.autoExpand(this); knowstaApp.methods.validateInput()"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); knowstaApp.methods.sendMessage(); }"
                    ></textarea>
                    
                    <!-- Send Button (Smaller, rounded, contained) -->
                    <button
                        id="send-button"
                        onclick="knowstaApp.methods.sendMessage()"
                        class="w-8 h-8 mr-1 my-0.5 bg-[#004aad] text-white rounded-full flex items-center justify-center shadow-lg hover:bg-[#003a89] transition duration-150 disabled:opacity-30 disabled:shadow-none animated-button"
                        disabled
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14m-7-7l7 7-7 7" transform="rotate(-45 12 12) translate(-1, 2)"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    
    <!-- Hidden file input -->
    <input type="file" id="file-input" class="hidden" onchange="knowstaApp.methods.handleFileUpload(event)" accept="image/*,application/pdf,text/plain">


    <!-- Settings Modal (RESTRUCTURED FOR SCROLLING) -->
    <div id="settings-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md dark:text-white flex flex-col">
            <!-- Modal Header -->
            <div class="flex-shrink-0 p-6 pb-4 flex justify-between items-center border-b dark:border-gray-700">
                <h2 class="text-2xl font-bold text-[#004aad] dark:text-white">App Settings</h2>
                <button onclick="knowstaApp.methods.hideSettingsModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <!-- Scrollable Settings Content -->
            <div class="p-6 overflow-y-auto" style="max-height: 75vh;">
                <div class="mb-6 pb-4 border-b dark:border-gray-700">
                    <p class="text-lg font-semibold mb-2">Appearance</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700 dark:text-gray-300">Current Theme: <span id="current-theme-label" class="font-medium">Light</span></span>
                        <button onclick="knowstaApp.methods.toggleTheme()" class="py-2 px-4 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-white rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 animated-button">
                            Toggle Light/Dark
                        </button>
                    </div>
                </div>
                
                <div class="mb-6 pb-4 border-b dark:border-gray-700">
                    <p class="text-lg font-semibold mb-2">Response Language</p>
                    <select id="modal-lang-selector" class="w-full p-3 border border-gray-300 rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white" onchange="knowstaApp.methods.updateLanguageFromModal()">
                        <option value="English">English</option>
                        <option value="Spanish">Español (ES)</option>
                        <option value="French">Français (FR)</option>
                        <option value="German">Deutsch (DE)</option>
                        <option value="Japanese">日本語 (JP)</option>
                        <option value="Chinese">中文 (ZH)</option>
                        <option value="Korean">한국어 (KO)</option>
                        <option value="Russian">Русский (RU)</option>
                        <option value="Arabic">العربية (AR)</option>
                        <option value="Vietnamese">Tiếng Việt (VI)</option>
                        <option value="Italian">Italiano (IT)</option>
                        <option value="Portuguese">Português (PT)</option>
                        <option value="Hindi">हिन्दी (HI)</option>
                    </select>
                </div>
                
                <div class="mb-6 pb-4 border-b dark:border-gray-700">
                    <p class="text-lg font-semibold mb-2">AI Personality Tone</p>
                    <select id="modal-tone-selector" class="w-full p-3 border border-gray-300 rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white" onchange="knowstaApp.methods.updateToneFromModal()">
                        <option value="Friendly">Friendly (Default)</option>
                        <option value="Professional">Professional (Formal, Concise)</option>
                        <option value="Creative">Creative (Imaginative, Vivid)</option>
                        <option value="Neutral">Neutral (Objective, Direct)</option>
                    </select>
                </div>

                <div class="mb-6 pb-4 border-b dark:border-gray-700">
                    <p class="text-lg font-semibold mb-2">Audio & Speech</p>
                    <label for="modal-voice-selector" class="block text-sm text-gray-700 dark:text-gray-300 mb-2">Text-to-Speech Voice</label>
                    <select id="modal-voice-selector" class="w-full p-3 border border-gray-300 rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white" onchange="knowstaApp.methods.updateVoiceFromModal()">
                        <option value="Iapetus">Iapetus (Clear)</option>
                        <option value="Erinome">Erinome (Clear)</option>
                        <option value="Charon">Charon (Informative)</option>
                        <option value="Kore">Kore (Firm)</option>
                        <option value="Puck">Puck (Upbeat)</option>
                        <option value="Zephyr">Zephyr (Bright)</option>
                        <option value="Algenib">Algenib (Gravelly)</option>
                        <option value="Sulafat">Sulafat (Warm)</option>
                        <option value="Achird">Achird (Friendly)</option>
                        <option value="Leda">Leda (Youthful)</option>
                    </select>
                </div>
                
                <div class="mb-6">
                     <p class="text-lg font-semibold mb-2">Data Management</p>
                     <button onclick="knowstaApp.methods.clearAllData()" class="w-full py-2 px-4 bg-red-600 text-white rounded-xl hover:bg-red-700 animated-button">
                          Clear My Data
                     </button>
                     <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">This will permanently delete all your chat history and profile bio stored in this browser.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- About Modal -->
    <div id="about-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm dark:text-white relative">
            <button onclick="knowstaApp.methods.hideAboutModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-center text-[#004aad]">Knowsta</h2>
            <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
                Knowsta is an intelligent conversational AI assistant designed for seamless, contextual interaction. It is powered by the advanced **Gemini 2.5 Flash** model, ensuring fast, relevant, and well-structured answers.
            </p>
            
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 space-y-2">
                <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Developed by:</strong> Sithu Nyein</p>
                <!-- UPDATED CONNECT SECTION -->
                <div class="text-sm text-gray-700 dark:text-gray-300">
                    <strong>Connect:</strong> 
                    <a href="https://www.linkedin.com/in/sithunyein/" target="_blank" class="text-[#004aad] hover:text-[#003a89] underline">LinkedIn</a> |
                    <a href="https://github.com/MrSTNyein" target="_blank" class="text-[#004aad] hover:text-[#003a89] underline">GitHub</a>
                </div>
                <p class="text-sm text-gray-700 dark:text-gray-300"><strong>Authentication provided by:</strong> Supabase</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 pt-2">Core AI is powered by Gemini 2.5 Flash.</p>
            </div>
        </div>
    </div>

    <!-- User Profile Modal (Used as Auth/Profile View) -->
    <div id="profile-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm dark:text-white relative">
             <button onclick="knowstaApp.methods.hideProfileModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-center text-[#004aad]">User Profile / Sign In</h2>
            
            <div id="profile-content" class="flex flex-col items-center space-y-4">
                <img id="profile-avatar-img" src="https://placehold.co/80x80/cccccc/ffffff?text=U" alt="Profile Avatar" class="w-20 h-20 rounded-full border-4 border-[#004aad]">
                <p id="profile-name-text" class="text-lg font-semibold dark:text-white">User Name</p>
                <p id="profile-id-text" class="text-xs text-gray-500 dark:text-gray-400 break-all">ID: </p>
                <div class="w-full space-y-2">
                    <label for="profile-bio" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Bio / About Me (Local Storage)</label>
                    <textarea id="profile-bio" oninput="knowstaApp.methods.saveProfileCustomization()" placeholder="Tell people about yourself..." rows="3" class="w-full p-2 border border-gray-300 rounded-xl focus:ring-[#004aad] focus:border-[#004aad] dark:bg-gray-700 dark:border-gray-600"></textarea>
                </div>

                <!-- NEW: Account Settings Section -->
                <div id="account-settings-container" class="w-full space-y-4 pt-4 border-t dark:border-gray-700">
                    <p class="text-xs font-semibold text-gray-600 dark:text-gray-300">Account Management</p>
                    
                    <!-- Update Name -->
                    <div class="flex items-center gap-2">
                        <input type="text" id="profile-name-input" placeholder="New display name" class="flex-grow p-2 border border-gray-300 rounded-xl focus:ring-[#004aad] focus:border-[#004aad] dark:bg-gray-700 dark:border-gray-600">
                        <button onclick="knowstaApp.methods.updateUsername()" class="py-2 px-3 bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-white text-sm rounded-xl hover:bg-gray-300 dark:hover:bg-gray-500 animated-button">Save</button>
                    </div>

                    <!-- Update Password (for email auth users only) -->
                    <div id="password-update-container" class="hidden space-y-2">
                        <input type="password" id="profile-new-password" placeholder="New password (min 6 chars)" class="w-full p-2 border border-gray-300 rounded-xl focus:ring-[#004aad] focus:border-[#004aad] dark:bg-gray-700 dark:border-gray-600">
                        <button onclick="knowstaApp.methods.updatePassword()" class="w-full py-2 px-4 bg-gray-700 text-white font-semibold rounded-xl hover:bg-gray-800 animated-button dark:bg-gray-600 dark:hover:bg-gray-700">Update Password</button>
                    </div>
                    
                    <p id="account-settings-message" class="text-sm text-center text-green-600 dark:text-green-400 hidden"></p>
                </div>

                <button 
                    id="profile-auth-button"
                    onclick="knowstaApp.methods.handleAuthClick(); knowstaApp.methods.hideProfileModal();" 
                    class="w-full py-2 px-4 bg-red-600 text-white rounded-xl shadow-md hover:bg-red-700 transition duration-150 animated-button">
                    Sign Out
                </button>
                <div class="w-full space-y-3 pt-4 border-t dark:border-gray-700 hidden" id="auth-form-container">
                    <p class="text-xs font-semibold text-gray-600 dark:text-gray-300">Sign In / Register</p>
                    <input type="email" id="modal-email-input" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-[#004aad] focus:border-[#004aad] dark:bg-gray-700 dark:border-gray-600">
                    <input type="password" id="modal-password-input" placeholder="Password (min 6 characters)" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-[#004aad] focus:border-[#004aad] dark:bg-gray-700 dark:border-gray-600">
                    <button id="modal-email-auth-button" onclick="knowstaApp.methods.handleModalEmailAuth()" class="w-full py-3 px-4 bg-gray-700 text-white font-semibold rounded-xl hover:bg-gray-800 animated-button dark:bg-gray-600 dark:hover:bg-gray-700">
                        Submit
                    </button>
                    <p id="modal-auth-message" class="text-sm text-center text-red-500 hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase & App Script -->
    <script type="module">
        // Import Supabase Client
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- GLOBAL APP OBJECT ---
        const knowstaApp = {
            // --- CONFIGURATION ---
            config: {
                SUPABASE_URL: 'https://nreviyisnhwckepaiglq.supabase.co',
                SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yZXZpeWlzbmh3Y2tlcGFpZ2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjU0OTAsImV4cCI6MjA3NTM0MTQ5MH0.g3GRHAXq-_TcTqKubarOSO-pKyXj4VHko6x84ImC2kg',
                FLASH_MODEL: 'gemini-2.5-flash-preview-05-20',
                API_KEY: "AIzaSyDSu08MpDaX18VVU4-A-XuOBwlaEOY8eF4", // WARNING: Exposed API Key. For production, proxy this.
                THEME_KEY: 'knowsta_theme',
                LANG_KEY: 'knowsta_lang',
                TONE_KEY: 'knowsta_tone',
                VOICE_KEY: 'knowsta_voice',
                CREATOR_BIO: "Sithu Nyein (born 2003) is a 22-year-old Myanmar-based digital marketer and entrepreneur, currently enhancing his skills through Coursera’s professional programs. He is the founder of Knowsta, an upcoming AI-powered chat application designed to deliver smarter, more creative, and user-friendly conversations for global users. Sithu aims to make AI assistance more personalized, accessible, and efficient, bridging the gap between human communication and artificial intelligence.",
                MINIMUM_LOAD_MS: 2500,
            },

            // --- APPLICATION STATE ---
            state: {
                chatHistory: [],
                allChats: {},
                currentChatId: null,
                userId: 'guest',
                supabase: null,
                speechRecognition: null,
                responseTone: 'Friendly',
                ttsVoice: 'Iapetus',
                profileBio: '',
                isListening: false,
                audioContext: null,
                isGenerating: false,
                stopGenerationRequested: false,
                attachedFile: null,
                activePersona: 'general', // NEW: To track the current AI persona
            },
            
            // --- UI ELEMENT REFERENCES ---
            ui: {},

            // --- METHODS / FUNCTIONS ---
            methods: {},

            // --- INITIALIZATION ---
            init() {
                // 1. Initialize Supabase
                this.state.supabase = createClient(this.config.SUPABASE_URL, this.config.SUPABASE_ANON_KEY);
                
                // 2. Cache UI elements
                this.ui = {
                    appContainer: document.getElementById('app'),
                    preloader: document.getElementById('preloader'),
                    chatWindow: document.getElementById('chat-window'),
                    userInput: document.getElementById('user-input'),
                    sendButton: document.getElementById('send-button'),
                    loadingIndicator: document.getElementById('loading-indicator'),
                    loadingMessage: document.getElementById('loading-message'),
                    authButton: document.getElementById('auth-button'),
                    userAvatar: document.getElementById('user-avatar'),
                    themeIcon: document.getElementById('theme-icon-sidebar'),
                    aboutModal: document.getElementById('about-modal'),
                    settingsModal: document.getElementById('settings-modal'),
                    currentThemeLabel: document.getElementById('current-theme-label'),
                    modalLangSelector: document.getElementById('modal-lang-selector'),
                    modalToneSelector: document.getElementById('modal-tone-selector'),
                    modalVoiceSelector: document.getElementById('modal-voice-selector'),
                    micButton: document.getElementById('mic-button'),
                    profileModal: document.getElementById('profile-modal'),
                    profileAvatarImg: document.getElementById('profile-avatar-img'),
                    profileNameText: document.getElementById('profile-name-text'),
                    profileIdText: document.getElementById('profile-id-text'),
                    profileBioInput: document.getElementById('profile-bio'),
                    sidebarUsername: document.getElementById('sidebar-username'),
                    userAvatarSidebar: document.getElementById('user-avatar-sidebar'),
                    labelNewChat: document.getElementById('label-new-chat'),
                    labelSettings: document.getElementById('label-settings'),
                    labelExport: document.getElementById('label-export'),
                    labelAbout: document.getElementById('label-about'),
                    chatHistoryList: document.getElementById('chat-history-list'),
                    stopGeneratingBtn: document.getElementById('stop-generating-btn'),
                    hamburgerBtn: document.getElementById('hamburger-btn'),
                    mobileMenuOverlay: document.getElementById('mobile-menu-overlay'),
                    sidebar: document.querySelector('.sidebar'),
                    accountSettingsContainer: document.getElementById('account-settings-container'),
                    profileNameInput: document.getElementById('profile-name-input'),
                    passwordUpdateContainer: document.getElementById('password-update-container'),
                    profileNewPasswordInput: document.getElementById('profile-new-password'),
                    accountSettingsMessage: document.getElementById('account-settings-message'),
                    attachmentPreview: document.getElementById('attachment-preview'),
                    fileInput: document.getElementById('file-input'),
                };
                
                // 3. Bind methods to the app context
                for (const key in this.methods) {
                    this.methods[key] = this.methods[key].bind(this);
                }
                
                // 4. Set up core services and event listeners
                this.methods.setupSound();
                this.methods.setupSpeechRecognition();
                this.ui.hamburgerBtn.addEventListener('click', this.methods.toggleMobileMenu);
                this.ui.mobileMenuOverlay.addEventListener('click', this.methods.toggleMobileMenu);


                // 5. Load settings and data
                this.methods.loadTheme();
                this.methods.loadLanguage();
                this.methods.loadTone();
                this.methods.loadVoice();
                
                // 6. Set up Auth listeners
                this.state.supabase.auth.onAuthStateChange((event, session) => {
                    const user = session?.user;
                    this.methods.updateAuthUI(user);
                    this.methods.translateUI(localStorage.getItem(this.config.LANG_KEY) || 'English');
                    if (event === 'SIGNED_IN') {
                        this.methods.addMessage('system', `Welcome, ${user.user_metadata.full_name || 'User'}! I am ready to assist you.`);
                        this.methods.hideProfileModal();
                    }
                });

                // 7. Start the app loading sequence
                const minimumLoadTime = new Promise(resolve => setTimeout(resolve, this.config.MINIMUM_LOAD_MS));
                const authReadyCheck = this.state.supabase.auth.getSession();

                Promise.all([minimumLoadTime, authReadyCheck]).then(([, { data: { session } }]) => {
                    this.methods.updateAuthUI(session?.user);
                    
                    this.methods.loadAllChats();
                    
                    if (!this.state.currentChatId) {
                       this.methods.startNewChat();
                    }

                    this.methods.loadProfileCustomization();
                    this.methods.validateInput();

                    this.ui.preloader.classList.add('opacity-0');
                    this.ui.preloader.addEventListener('transitionend', () => {
                        this.ui.preloader.classList.add('hidden');
                        this.ui.appContainer.classList.remove('opacity-0');
                    }, { once: true });
                });
            }
        };
        
        // --- DEFINE ALL METHODS ---

        knowstaApp.methods = {

            // --- PERSISTENCE HELPERS ---
            getChatsKey(id) {
                return `knowsta_all_chats_${id}`;
            },
            getProfileBioKey(id) {
                return `knowsta_bio_${id}`;
            },

            // --- SOUND MANAGER (Using Web Audio API for speed) ---
            setupSound() {
                try {
                    this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const resumeContext = () => {
                        if (this.state.audioContext.state === 'suspended') {
                            this.state.audioContext.resume();
                        }
                        document.body.removeEventListener('click', resumeContext);
                        document.body.removeEventListener('touchend', resumeContext);
                    };
                    document.body.addEventListener('click', resumeContext, { once: true });
                    document.body.addEventListener('touchend', resumeContext, { once: true });
                } catch (e) {
                    console.warn("Web Audio API is not supported in this browser.");
                    this.state.audioContext = null;
                }
            },
            playSendSound() {
                if (!this.state.audioContext) return;
                const oscillator = this.state.audioContext.createOscillator();
                const gainNode = this.state.audioContext.createGain();
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(880, this.state.audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.2, this.state.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, this.state.audioContext.currentTime + 0.1);
                oscillator.connect(gainNode);
                gainNode.connect(this.state.audioContext.destination);
                oscillator.start(this.state.audioContext.currentTime);
                oscillator.stop(this.state.audioContext.currentTime + 0.1);
            },
            playReceiveSound() {
                if (!this.state.audioContext) return;
                const oscillator = this.state.audioContext.createOscillator();
                const gainNode = this.state.audioContext.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, this.state.audioContext.currentTime);
                oscillator.frequency.setValueAtTime(659.25, this.state.audioContext.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.15, this.state.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, this.state.audioContext.currentTime + 0.3);
                oscillator.connect(gainNode);
                gainNode.connect(this.state.audioContext.destination);
                oscillator.start(this.state.audioContext.currentTime);
                oscillator.stop(this.state.audioContext.currentTime + 0.3);
            },

            // --- LOCALIZATION ---
            getLocalizedText(key) {
                const localizationData = {
                    'English': { 'sidebar_username': 'Sign In / Profile', 'btn_new_chat': 'New Chat', 'btn_settings': 'Settings', 'btn_export': 'Export Conversation (.txt)', 'btn_about': 'About Knowsta', 'btn_signin': 'Sign In', 'btn_signout': 'Sign Out', 'head_conversation': 'Knowsta', 'head_settings': 'App Settings', 'theme_label': 'Current Theme:', 'theme_toggle': 'Toggle Light/Dark', 'lang_label': 'Response Language', 'tone_label': 'AI Personality Tone', 'close': 'Close', 'submit': 'Submit', 'user_name_default': 'User Name', 'profile_signin': 'User Profile / Sign In', 'welcome_head': 'How can I help you?', 'welcome_sub': 'I\'m ready to assist you.', 'welcome_text': 'Start by asking a factual question, requesting code, or a creative prompt.', 'placeholder': 'Ask anything...' },
                    'Spanish': { 'sidebar_username': 'Iniciar Sesión / Perfil', 'btn_new_chat': 'Nuevo Chat', 'btn_settings': 'Ajustes', 'btn_export': 'Exportar Conversación (.txt)', 'btn_about': 'Acerca de Knowsta', 'btn_signin': 'Iniciar Sesión', 'btn_signout': 'Cerrar Sesión', 'head_conversation': 'Knowsta', 'head_settings': 'Configuración de la Aplicación', 'theme_label': 'Tema Actual:', 'theme_toggle': 'Alternar Tema', 'lang_label': 'Idioma de Respuesta', 'tone_label': 'Tono de Personalidad IA', 'close': 'Cerrar', 'submit': 'Enviar', 'user_name_default': 'Nombre de Usuario', 'profile_signin': 'Perfil de Usuario / Iniciar Sesión', 'welcome_head': '¿Cómo puedo ayudarte?', 'welcome_sub': 'Estoy listo para asistirte.', 'welcome_text': 'Comienza haciendo una pregunta, solicitando código o una sugerencia creativa.', 'placeholder': 'Pregunta lo que sea...' },
                    'French': { 'sidebar_username': 'Connexion / Profil', 'btn_new_chat': 'Nouveau Chat', 'btn_settings': 'Paramètres', 'btn_export': 'Exporter la conversation (.txt)', 'btn_about': 'À propos de Knowsta', 'btn_signin': 'Se Connecter', 'btn_signout': 'Déconnexion', 'head_conversation': 'Knowsta', 'head_settings': 'Paramètres de l\'Appli', 'theme_label': 'Thème Actuel :', 'theme_toggle': 'Basculer Thème', 'lang_label': 'Langue de Réponse', 'tone_label': 'Ton de Personnalité IA', 'close': 'Fermer', 'submit': 'Soumettre', 'user_name_default': 'Nom d\'utilisateur', 'profile_signin': 'Profil Utilisateur / Connexion', 'welcome_head': 'Comment puis-je vous aider ?', 'welcome_sub': 'Je suis prêt à vous assister.', 'welcome_text': 'Commencez par poser une question, demander du code ou une invite créative.', 'placeholder': 'Demandez n\'importe quoi...' },
                };
                const lang = localStorage.getItem(this.config.LANG_KEY) || 'English';
                return (localizationData[lang] && localizationData[lang][key]) || localizationData['English'][key];
            },
            translateUI(lang) {
                const conversationHeader = this.ui.appContainer.querySelector('.main-chat-panel header h1');
                if (conversationHeader) conversationHeader.textContent = this.methods.getLocalizedText('head_conversation');
                
                const authBtnText = this.state.supabase?.auth.currentUser ? this.methods.getLocalizedText('btn_signout') : this.methods.getLocalizedText('btn_signin');
                this.ui.authButton.textContent = authBtnText;
                
                this.ui.sidebarUsername.textContent = this.methods.getLocalizedText('sidebar_username');
                if (this.ui.labelNewChat) this.ui.labelNewChat.textContent = this.methods.getLocalizedText('btn_new_chat');
                if (this.ui.labelSettings) this.ui.labelSettings.textContent = this.methods.getLocalizedText('btn_settings');
                if (this.ui.labelExport) this.ui.labelExport.textContent = this.methods.getLocalizedText('btn_export');
                if (this.ui.labelAbout) this.ui.labelAbout.textContent = this.methods.getLocalizedText('btn_about');
                
                if (this.ui.settingsModal) {
                    const h2 = this.ui.settingsModal.querySelector('h2');
                    if (h2) h2.textContent = this.methods.getLocalizedText('head_settings');
                    
                    const pElements = this.ui.settingsModal.querySelectorAll('.mb-6 p');
                    if (pElements[0]) pElements[0].textContent = 'Appearance';
                    if (pElements[1]) pElements[1].textContent = this.methods.getLocalizedText('lang_label');
                    if (pElements[2]) pElements[2].textContent = this.methods.getLocalizedText('tone_label');

                    const toggleBtn = this.ui.settingsModal.querySelector('[onclick*="toggleTheme"]');
                    if (toggleBtn) toggleBtn.textContent = this.methods.getLocalizedText('theme_toggle');
                }
                
                if (this.ui.profileModal) {
                    const h2 = this.ui.profileModal.querySelector('h2');
                    if (h2) h2.textContent = this.methods.getLocalizedText('profile_signin');
                    
                    const profileAuthButton = document.getElementById('profile-auth-button');
                    if (profileAuthButton) profileAuthButton.textContent = this.state.supabase?.auth.currentUser ? this.methods.getLocalizedText('btn_signout') : this.methods.getLocalizedText('btn_signin');
                }
                
                if (this.ui.userInput) {
                    this.ui.userInput.placeholder = this.methods.getLocalizedText('placeholder');
                }
            },
            
            // --- THEME & APPEARANCE ---
            applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.body.classList.add('dark');
                    if (this.ui.themeIcon) this.ui.themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />`;
                    this.ui.currentThemeLabel.textContent = 'Dark';
                } else {
                    document.documentElement.classList.remove('dark');
                    document.body.classList.remove('dark');
                    if (this.ui.themeIcon) this.ui.themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`;
                    this.ui.currentThemeLabel.textContent = 'Light';
                }
            },
            toggleTheme() {
                const currentTheme = localStorage.getItem(this.config.THEME_KEY);
                const newTheme = (currentTheme === 'light' || !currentTheme) ? 'dark' : 'light';
                localStorage.setItem(this.config.THEME_KEY, newTheme);
                this.methods.applyTheme(newTheme);
            },
            loadTheme() {
                const savedTheme = localStorage.getItem(this.config.THEME_KEY) || 'light';
                this.methods.applyTheme(savedTheme);
            },
            
            // --- SETTINGS & PERSONAS ---
            setPersona(persona) {
                this.state.activePersona = persona;
                
                const personaButtons = document.querySelectorAll('#persona-buttons .persona-button');
                personaButtons.forEach(btn => btn.classList.remove('active-persona'));
                const activeButton = document.getElementById(`persona-${persona}`);
                if (activeButton) {
                    activeButton.classList.add('active-persona');
                }
                
                this.methods.startNewChat();
                
                if (window.innerWidth <= 768 && this.ui.sidebar.classList.contains('open')) {
                    this.methods.toggleMobileMenu();
                }
            },
            resetToGeneralChat() {
                this.methods.setPersona('general');
            },
            updateLanguage(selectedLang) {
                localStorage.setItem(this.config.LANG_KEY, selectedLang);
                this.methods.translateUI(selectedLang);
            },
            updateLanguageFromModal() {
                const selectedLang = this.ui.modalLangSelector.value;
                this.methods.updateLanguage(selectedLang);
            },
            loadLanguage() {
                const savedLang = localStorage.getItem(this.config.LANG_KEY) || 'English';
                this.methods.updateLanguage(savedLang);
                if (this.ui.modalLangSelector) this.ui.modalLangSelector.value = savedLang;
            },
            updateTone(selectedTone) {
                this.state.responseTone = selectedTone;
                localStorage.setItem(this.config.TONE_KEY, this.state.responseTone);
            },
            updateToneFromModal() {
                const selectedTone = this.ui.modalToneSelector.value;
                this.methods.updateTone(selectedTone);
            },
            loadTone() {
                const savedTone = localStorage.getItem(this.config.TONE_KEY) || 'Friendly';
                this.methods.updateTone(savedTone);
                if (this.ui.modalToneSelector) this.ui.modalToneSelector.value = savedTone;
            },
            updateVoice(selectedVoice) {
                this.state.ttsVoice = selectedVoice;
                localStorage.setItem(this.config.VOICE_KEY, this.state.ttsVoice);
            },
            updateVoiceFromModal() {
                const selectedVoice = this.ui.modalVoiceSelector.value;
                this.methods.updateVoice(selectedVoice);
            },
            loadVoice() {
                const savedVoice = localStorage.getItem(this.config.VOICE_KEY) || 'Iapetus';
                this.methods.updateVoice(savedVoice);
                if (this.ui.modalVoiceSelector) this.ui.modalVoiceSelector.value = savedVoice;
            },
            toggleMobileMenu() {
                this.ui.sidebar.classList.toggle('open');
                this.ui.mobileMenuOverlay.classList.toggle('hidden');
            },
            
            // --- PROFILE & HISTORY ---
            saveProfileCustomization() {
                this.state.profileBio = this.ui.profileBioInput.value;
                localStorage.setItem(this.methods.getProfileBioKey(this.state.userId), this.state.profileBio);
            },
            loadProfileCustomization() {
                this.state.profileBio = localStorage.getItem(this.methods.getProfileBioKey(this.state.userId)) || '';
                if (this.ui.profileBioInput) this.ui.profileBioInput.value = this.state.profileBio;
            },
            saveAllChats() {
                if (this.state.currentChatId && this.state.chatHistory.length > 0) {
                    this.state.allChats[this.state.currentChatId] = this.state.chatHistory;
                }
                localStorage.setItem(this.methods.getChatsKey(this.state.userId), JSON.stringify(this.state.allChats));
                this.methods.renderChatHistoryList();
            },
            loadAllChats() {
                const savedChats = localStorage.getItem(this.methods.getChatsKey(this.state.userId));
                if (savedChats) {
                    try {
                        this.state.allChats = JSON.parse(savedChats);
                        const chatIds = Object.keys(this.state.allChats);
                         if (chatIds.length > 0) {
                             this.methods.loadChat(chatIds[chatIds.length - 1]);
                        }
                    } catch(e) {
                         this.state.allChats = {};
                    }
                } else {
                    this.state.allChats = {};
                }
                this.methods.renderChatHistoryList();
            },
            
            // --- MODAL HANDLERS ---
            showAboutModal() { this.ui.aboutModal.classList.remove('hidden'); this.ui.aboutModal.classList.add('flex'); },
            hideAboutModal() { this.ui.aboutModal.classList.add('hidden'); this.ui.aboutModal.classList.remove('flex'); },
            showSettingsModal() {
                this.ui.modalLangSelector.value = localStorage.getItem(this.config.LANG_KEY) || 'English';
                this.ui.modalToneSelector.value = localStorage.getItem(this.config.TONE_KEY) || 'Friendly';
                this.ui.modalVoiceSelector.value = localStorage.getItem(this.config.VOICE_KEY) || 'Iapetus';
                this.ui.settingsModal.classList.remove('hidden');
                this.ui.settingsModal.classList.add('flex');
            },
            hideSettingsModal() { this.ui.settingsModal.classList.add('hidden'); this.ui.settingsModal.classList.remove('flex'); },
            handleAuthClickOrProfile() {
                const { data: { user } } = this.state.supabase.auth.getUser();
                if (user) {
                    this.methods.showProfileModal();
                } else {
                    this.methods.handleAuthClick();
                }
            },
            showProfileModal() {
                 const { data: { session } } = this.state.supabase.auth.getSession();
                 const user = session?.user;

                if (!user) {
                    this.methods.handleAuthClick(); // Fallback to auth flow if no user
                    return;
                }
                
                this.ui.accountSettingsMessage.classList.add('hidden');
                this.ui.profileNameInput.value = '';
                this.ui.profileNewPasswordInput.value = '';
                
                const displayName = user?.user_metadata.full_name || user?.email || 'User';
                const avatarUrl = user?.user_metadata.avatar_url;
                const uid = user?.id || 'N/A';
                this.ui.profileNameText.textContent = displayName;
                this.ui.profileIdText.textContent = `ID: ${uid}`;
                this.ui.profileAvatarImg.src = avatarUrl || this.ui.userAvatar.src;
                this.methods.loadProfileCustomization();
                const profileAuthButton = document.getElementById('profile-auth-button');
                const authFormContainer = document.getElementById('auth-form-container');
                profileAuthButton.textContent = this.methods.getLocalizedText('btn_signout');
                profileAuthButton.classList.replace('bg-indigo-600', 'bg-red-600');
                authFormContainer.classList.add('hidden');
                
                if (user.app_metadata.provider === 'email') {
                    this.ui.passwordUpdateContainer.classList.remove('hidden');
                } else {
                    this.ui.passwordUpdateContainer.classList.add('hidden');
                }

                this.ui.profileModal.classList.remove('hidden');
                this.ui.profileModal.classList.add('flex');
            },
            hideProfileModal() { this.ui.profileModal.classList.add('hidden'); this.ui.profileModal.classList.remove('flex'); },

            // --- CHAT LOGIC ---
            startNewChat() {
                if (this.state.isGenerating) this.methods.stopGeneration();
                this.methods.saveAllChats();
                
                this.state.chatHistory = [];
                this.state.currentChatId = `chat_${Date.now()}`;
                this.ui.chatWindow.innerHTML = '';
                
                const persona = this.state.activePersona;
                const personaWelcomes = {
                    general: {
                        head: 'How can I help you?',
                        sub: 'I\'m ready to assist with any topic.',
                        text: 'Select a persona on the left or ask me anything.'
                    },
                    marketing: {
                        head: 'Marketing Maestro',
                        sub: 'Ready to craft your next campaign.',
                        text: 'Ask for strategies, ad copy, or market analysis.'
                    },
                    learn: {
                        head: 'Learning Companion',
                        sub: 'Here to help you understand new concepts.',
                        text: 'Ask me to explain topics, summarize articles, or test your knowledge.'
                    },
                    coding: {
                        head: 'Coding Co-pilot',
                        sub: 'Your partner in programming.',
                        text: 'Ask for code snippets, debugging help, or algorithm explanations.'
                    }
                };
                const welcome = personaWelcomes[persona] || personaWelcomes['general'];

                const messageDiv = document.createElement('div');
                messageDiv.id = 'initial-message';
                messageDiv.className = 'flex justify-center mt-20';
                messageDiv.innerHTML = `<div class="text-center max-w-md px-4 text-gray-500 transition duration-300">
                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">${welcome.head}</h3>
                    <p class="text-lg font-semibold mb-2">${welcome.sub}</p>
                    <p class="text-sm">${welcome.text}</p>
                </div>`;

                this.ui.chatWindow.appendChild(messageDiv);
                this.methods.saveAllChats();
            },
            loadChat(chatId) {
                if (this.state.isGenerating) this.methods.stopGeneration();
                if (this.state.allChats[chatId]) {
                    this.methods.saveAllChats();
                    this.state.currentChatId = chatId;
                    this.state.chatHistory = this.state.allChats[chatId];
                    this.ui.chatWindow.innerHTML = '';
                    this.state.chatHistory.forEach(msg => this.methods.addMessage(msg.role, msg.parts, false, msg.time));
                    setTimeout(() => { this.ui.chatWindow.scrollTop = this.ui.chatWindow.scrollHeight; }, 100);
                    this.methods.renderChatHistoryList();
                }
                if (window.innerWidth <= 768 && this.ui.sidebar.classList.contains('open')) {
                    this.methods.toggleMobileMenu();
                }
            },
            sendTopic(topicText) {
                this.ui.userInput.value = topicText;
                this.methods.autoExpand(this.ui.userInput);
                this.methods.sendMessage();
            },
            exportChat() {
                const chatElements = this.ui.chatWindow.children;
                if (chatElements.length === 0 || chatElements[0].id === 'initial-message') {
                    this.methods.addMessage('system', 'No conversation to export.');
                    return;
                }
                let exportText = `# Knowsta Chat Log\n\nDate: ${new Date().toLocaleString()}\n---\n\n`;
                for (const el of chatElements) {
                    const bubble = el.querySelector('.chat-bubble-user, .chat-bubble-ai');
                    if (bubble) {
                        const role = bubble.classList.contains('chat-bubble-user') ? 'User' : 'Knowsta';
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = bubble.innerHTML;
                        const text = tempDiv.textContent.trim().replace(/\s*\n\s*/g, '\n');
                        exportText += `**${role}:** ${text}\n\n`;
                    } else if (el.textContent.includes('system')) {
                        exportText += `[System Message] ${el.textContent.trim()}\n\n`;
                    }
                }
                const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
                const filename = `Knowsta_Chat_${new Date().toISOString().slice(0, 10)}.txt`;
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                this.methods.addMessage('system', `Chat exported as "${filename}".`);
            },
            
            // --- AUTHENTICATION & ACCOUNT SETTINGS ---
            async updateUsername() {
                const newName = this.ui.profileNameInput.value.trim();
                if (!newName) {
                    this.ui.accountSettingsMessage.textContent = 'Name cannot be empty.';
                    this.ui.accountSettingsMessage.className = 'text-sm text-center text-red-500 dark:text-red-400';
                    this.ui.accountSettingsMessage.classList.remove('hidden');
                    return;
                }
                const { data, error } = await this.state.supabase.auth.updateUser({
                    data: { full_name: newName }
                });
                if (error) {
                    this.ui.accountSettingsMessage.textContent = `Error: ${error.message}`;
                    this.ui.accountSettingsMessage.className = 'text-sm text-center text-red-500 dark:text-red-400';
                    this.ui.accountSettingsMessage.classList.remove('hidden');
                } else {
                    this.ui.accountSettingsMessage.textContent = 'Name updated successfully!';
                    this.ui.accountSettingsMessage.className = 'text-sm text-center text-green-600 dark:text-green-400';
                    this.ui.accountSettingsMessage.classList.remove('hidden');
                    await this.state.supabase.auth.refreshSession();
                    this.methods.updateAuthUI(data.user);
                    this.ui.profileNameText.textContent = newName;
                    this.ui.profileNameInput.value = '';
                }
            },
            async updatePassword() {
                const newPassword = this.ui.profileNewPasswordInput.value;
                if (newPassword.length < 6) {
                    this.ui.accountSettingsMessage.textContent = 'Password must be at least 6 characters.';
                    this.ui.accountSettingsMessage.className = 'text-sm text-center text-red-500 dark:text-red-400';
                    this.ui.accountSettingsMessage.classList.remove('hidden');
                    return;
                }
                const { error } = await this.state.supabase.auth.updateUser({ password: newPassword });
                if (error) {
                    this.ui.accountSettingsMessage.textContent = `Error: ${error.message}`;
                    this.ui.accountSettingsMessage.className = 'text-sm text-center text-red-500 dark:text-red-400';
                    this.ui.accountSettingsMessage.classList.remove('hidden');
                } else {
                    this.ui.accountSettingsMessage.textContent = 'Password updated successfully!';
                    this.ui.accountSettingsMessage.className = 'text-sm text-center text-green-600 dark:text-green-400';
                    this.ui.accountSettingsMessage.classList.remove('hidden');
                    this.ui.profileNewPasswordInput.value = '';
                }
            },
            updateAuthUI(user) {
                const oldUserId = this.state.userId;
                if (user) {
                    const displayName = user.user_metadata.full_name || user.email || 'User';
                    const avatarUrl = user.user_metadata.avatar_url;
                    this.ui.authButton.textContent = this.methods.getLocalizedText('btn_signout');
                    this.ui.authButton.className = 'py-1 px-3 border border-gray-300 text-gray-700 text-sm rounded-full transition duration-150 hover:bg-gray-100 dark:border-gray-500 dark:text-gray-300 dark:hover:bg-gray-700 animated-button';
                    this.ui.userAvatar.src = avatarUrl || `https://placehold.co/32x32/004aad/ffffff?text=${displayName[0].toUpperCase()}`;
                    this.ui.userAvatar.classList.remove('hidden');
                    this.ui.sidebarUsername.textContent = displayName;
                    this.ui.userAvatarSidebar.src = this.ui.userAvatar.src;
                    this.state.userId = user.id;
                } else {
                    this.ui.authButton.textContent = this.methods.getLocalizedText('btn_signin');
                    this.ui.authButton.className = 'py-1 px-3 bg-[#004aad] text-white text-sm rounded-full transition duration-150 hover:bg-[#003a89] animated-button';
                    this.ui.userAvatar.classList.add('hidden');
                    this.ui.sidebarUsername.textContent = this.methods.getLocalizedText('sidebar_username');
                    this.ui.userAvatarSidebar.src = 'https://placehold.co/32x32/cccccc/ffffff?text=U';
                    this.state.userId = 'guest';
                }
                this.ui.sendButton.disabled = false;
                if (oldUserId !== this.state.userId) {
                    this.methods.saveAllChats();
                    this.methods.loadProfileCustomization();
                    this.methods.loadAllChats();
                    if (!this.state.currentChatId || Object.keys(this.state.allChats).length === 0) {
                        this.methods.startNewChat();
                    }
                }
            },
            async handleAuthClick() {
                this.methods.playSendSound();
                const { data: { session } } = await this.state.supabase.auth.getSession();
                if (session) {
                    try {
                        this.methods.saveAllChats();
                        await this.state.supabase.auth.signOut();
                        this.methods.startNewChat();
                        this.methods.addMessage('system', 'You have been signed out. Start a new chat.');
                        this.methods.playReceiveSound();
                    } catch (error) {
                        console.error("Supabase Sign out error:", error);
                        this.methods.addMessage('system', `Error signing out: ${error.message}. Please try again.`);
                    }
                } else {
                    try {
                        const { error } = await this.state.supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: `${window.location.origin}${window.location.pathname}` } });
                        if (error) throw error;
                    } catch (error) {
                        console.error("Supabase Google sign in error:", error);
                        this.methods.addMessage('system', `Error signing in with Google: ${error.message}. Please check your browser settings or try again.`);
                    }
                }
            },
            async handleModalEmailAuth() {
                const email = document.getElementById('modal-email-input').value;
                const password = document.getElementById('modal-password-input').value;
                const modalAuthMessage = document.getElementById('modal-auth-message');
                const emailAuthButton = document.getElementById('modal-email-auth-button');

                modalAuthMessage.classList.add('hidden');
                emailAuthButton.disabled = true;
                emailAuthButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Authenticating...`;

                if (!email || password.length < 6) {
                    modalAuthMessage.textContent = "Please enter a valid email and password (min 6 chars).";
                    modalAuthMessage.classList.remove('hidden');
                    emailAuthButton.disabled = false;
                    emailAuthButton.innerHTML = 'Submit';
                    return;
                }

                let { data, error } = await this.state.supabase.auth.signInWithPassword({ email, password });
                if (error && error.message.includes('Invalid login credentials')) {
                    ({ data, error } = await this.state.supabase.auth.signUp({ email, password }));
                    if (!error && data.user) {
                        modalAuthMessage.textContent = `Success! Signed up and logged in.`;
                        modalAuthMessage.classList.remove('hidden');
                    } else if (!error && data.session === null) {
                        modalAuthMessage.textContent = `Sign Up successful! Check your email to confirm your account.`;
                        modalAuthMessage.classList.remove('hidden');
                    }
                } else if (error) {
                    modalAuthMessage.textContent = `Auth Error: ${error.message}`;
                    modalAuthMessage.classList.remove('hidden');
                } else if (data.user) {
                    modalAuthMessage.textContent = `Welcome back, ${email}!`;
                    modalAuthMessage.classList.remove('hidden');
                }
                emailAuthButton.disabled = false;
                emailAuthButton.innerHTML = 'Submit';
            },

            // --- SPEECH RECOGNITION ---
            setupSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.state.speechRecognition = new SpeechRecognition();
                    this.state.speechRecognition.continuous = false;
                    this.state.speechRecognition.interimResults = true;
                    this.state.speechRecognition.lang = 'en-US';

                    this.state.speechRecognition.onstart = () => {
                        this.state.isListening = true;
                        this.ui.micButton.title = "Listening...";
                        this.ui.micButton.classList.replace('text-gray-500', 'text-red-500');
                        this.ui.micButton.classList.add('animate-pulse');
                        this.ui.userInput.focus();
                    };
                    this.state.speechRecognition.onresult = (event) => {
                        const transcript = Array.from(event.results).map(result => result[0]).map(result => result.transcript).join('');
                        this.ui.userInput.value = transcript;
                        this.methods.autoExpand(this.ui.userInput);
                        this.methods.validateInput();
                    };
                    this.state.speechRecognition.onend = () => {
                        this.state.isListening = false;
                        this.ui.micButton.title = "Start Voice Input";
                        this.ui.micButton.classList.replace('text-red-500', 'text-gray-500');
                        this.ui.micButton.classList.remove('animate-pulse');
                        if (this.ui.userInput.value.trim() !== '') {
                            this.methods.sendMessage();
                        }
                    };
                    this.state.speechRecognition.onerror = (event) => {
                        console.error('Speech recognition error', event);
                        this.methods.addMessage('system', `Voice input failed: ${event.error}. Ensure microphone access is allowed.`);
                        this.state.isListening = false;
                        this.ui.micButton.title = "Start Voice Input";
                        this.ui.micButton.classList.replace('text-red-500', 'text-gray-500');
                        this.ui.micButton.classList.remove('animate-pulse');
                    };
                } else {
                    this.ui.micButton.disabled = true;
                    this.ui.micButton.title = "Voice Input not supported by your browser.";
                }
            },
            toggleVoiceInput() {
                if (!this.state.speechRecognition) return;
                if (this.state.isListening) {
                    this.state.speechRecognition.stop();
                } else {
                    this.state.speechRecognition.start();
                }
            },

            // --- UI UTILITIES ---
            autoExpand(element) {
                element.style.height = 'auto';
                element.style.height = element.scrollHeight + 'px';
            },
            validateInput() {
                const hasInput = this.ui.userInput.value.trim() !== '' || this.state.attachedFile;
                this.ui.sendButton.disabled = !hasInput;
            },
            
            // --- MESSAGE RENDERING ---
            formatGeminiResponse(text) {
                const codeBlocks = [];
                let processedText = text.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                    const placeholder = `__CODEBLOCK_${codeBlocks.length}__`;
                    codeBlocks.push({ lang, code });
                    return placeholder;
                });

                processedText = processedText
                    .replace(/</g, "&lt;").replace(/>/g, "&gt;")
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/###\s*(.*)/g, '<h3 class="font-bold text-md mt-2 mb-1">$1</h3>')
                    .replace(/##\s*(.*)/g, '<h2 class="font-bold text-lg mt-3 mb-1">$1</h2>')
                    .replace(/^\s*\*\s+(.*)/gm, '__LIST_ITEM__$1');

                processedText = processedText.replace(/(__LIST_ITEM__.*(?:\n__LIST_ITEM__.*)*)/g, (match) => {
                    const items = match.replace(/__LIST_ITEM__/g, '<li class="ml-4 list-disc">')
                                       .replace(/\n/g, '</li>');
                    return `<ul class="list-disc space-y-1 my-2">${items}</li></ul>`;
                });

                processedText = processedText.replace(/\n/g, '<br>');

                codeBlocks.forEach((block, index) => {
                    const placeholder = `__CODEBLOCK_${index}__`;
                    const escapedCode = block.code.trim().replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const codeForButton = block.code.trim().replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '');

                    const codeHtml = `<pre><button class="copy-code-btn" onclick="knowstaApp.methods.copyToClipboard('${codeForButton}')">Copy</button><code class="language-${block.lang || ''}">${escapedCode}</code></pre>`;
                    processedText = processedText.replace(placeholder, codeHtml);
                });

                return processedText;
            },
            addMessage(role, content, isImageHtml = false, timestamp = null) {
                const suppressedMessages = [
                    'Generating audio...',
                    'Audio playback failed. Please check the console for details.',
                    'Regenerating response...'
                ];

                if (role === 'system' && suppressedMessages.includes(content)) {
                    console.log(`Suppressed system message: "${content}"`);
                    return null; 
                }

                const promptBlock = document.getElementById('initial-message');
                if (promptBlock) promptBlock.remove();

                const isUser = role === 'user';
                const messageId = `msg-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                const currentTime = timestamp || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                let textForControls = '';
                if (Array.isArray(content)) {
                    const textPart = content.find(part => part.text);
                    if (textPart) textForControls = textPart.text;
                } else {
                     textForControls = content;
                }
                const escapedTextForHtmlAttr = textForControls.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '');

                const messageContainer = document.createElement('div');
                messageContainer.className = `flex ${isUser ? 'justify-end user-message-wrapper' : 'justify-start ai-message-wrapper'}`;
                messageContainer.id = messageId;

                const contentBlock = document.createElement('div');
                contentBlock.className = 'flex flex-col';

                const bubble = document.createElement('div');
                const textContentDiv = document.createElement('div');
                textContentDiv.className = 'message-text-content';

                const isSystem = role === 'system';
                
                let bubbleClass = 'max-w-[85%] px-4 py-2 rounded-xl text-sm transition duration-300';
                if (isUser) {
                    bubbleClass += ' chat-bubble-user ml-auto';
                } else if (role === 'model') {
                    bubbleClass += ' chat-bubble-ai mr-auto';
                } else if (isSystem) {
                    bubbleClass = 'max-w-full text-center px-4 py-1 text-xs text-gray-500 transition duration-300';
                    textContentDiv.innerHTML = textForControls;
                    bubble.appendChild(textContentDiv);
                }
                bubble.className = bubbleClass;
                
                if (!isSystem) {
                     if (Array.isArray(content)) {
                         content.forEach(part => {
                             if(part.text) {
                                 textContentDiv.innerHTML += this.methods.formatGeminiResponse(part.text);
                             }
                             if (part.inlineData) {
                                 const img = document.createElement('img');
                                 img.src = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                                 img.className = 'mt-2 rounded-lg max-w-full h-auto';
                                 bubble.appendChild(img);
                             }
                         });
                     } else {
                         textContentDiv.innerHTML = this.methods.formatGeminiResponse(content);
                     }
                     bubble.appendChild(textContentDiv);
                }

                if (!isSystem) {
                    contentBlock.appendChild(bubble);
                    const controls = document.createElement('div');
                    controls.className = 'message-controls flex gap-1 mt-1 text-gray-400 dark:text-gray-500 text-xs opacity-0 transition duration-200';
                    controls.innerHTML += `<button onclick="knowstaApp.methods.copyToClipboard('${escapedTextForHtmlAttr}')" class="hover:text-[#004aad] px-1 rounded-md" title="Copy Text"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>`;

                    if (isUser) {
                        controls.innerHTML += `<button onclick="knowstaApp.methods.editMessage('${messageId}', '${escapedTextForHtmlAttr}')" class="hover:text-[#004aad] px-1 rounded-md" title="Edit Message"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.836a2.121 2.121 0 013 3L7 19H4v-3L16.732 3.268a2.121 2.121 0 013 0z" /></svg></button>`;
                        controls.innerHTML += `<button onclick="knowstaApp.methods.deleteMessage('${messageId}')" class="hover:text-red-500 px-1 rounded-md" title="Delete Message"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                        contentBlock.appendChild(controls);
                        contentBlock.classList.add('items-end');
                        contentBlock.innerHTML += `<p class="timestamp text-gray-500 dark:text-gray-400 self-end">${currentTime}</p>`;
                    } else if (role === 'model') {
                        controls.innerHTML += `<button onclick="knowstaApp.methods.listenToMessage('${escapedTextForHtmlAttr}')" class="hover:text-[#004aad] px-1 rounded-md" title="Listen to Answer"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg></button>`;
                        controls.innerHTML += `<button onclick="knowstaApp.methods.regenerateResponse('${messageId}')" class="hover:text-[#004aad] px-1 rounded-md" title="Regenerate Response"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0 4.142-3.358 7.5-7.5 7.5s-7.5-3.358-7.5-7.5 3.358-7.5 7.5-7.5c2.31 0 4.388.98 5.832 2.5l-2.332 2.332M19.5 2.5v5h-5" /></svg></button>`;
                        controls.innerHTML += `<button onclick="knowstaApp.methods.deleteMessage('${messageId}')" class="hover:text-red-500 px-1 rounded-md" title="Delete Message"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                        contentBlock.appendChild(controls);
                        contentBlock.classList.add('items-start');
                        contentBlock.innerHTML += `<p class="timestamp text-gray-500 dark:text-gray-400 self-start">${currentTime}</p>`;
                    }
                    messageContainer.appendChild(contentBlock);
                } else {
                    messageContainer.appendChild(bubble);
                }
                this.ui.chatWindow.appendChild(messageContainer);
                this.ui.chatWindow.scrollTop = this.ui.chatWindow.scrollHeight;
                return messageContainer;
            },
            
            async fetchWithRetry(url, payload, maxRetries = 3) {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (response.ok) return await response.json();
                        if (response.status >= 500 || response.status === 429) throw new Error(`Server error or rate limited: Status ${response.status}`);
                        const errorBody = await response.json();
                        throw new Error(`API call failed: ${response.status} - ${JSON.stringify(errorBody)}`);
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed:`, error.message);
                        if (i === maxRetries - 1) throw error;
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            },
            
            // --- MESSAGE ACTIONS ---
            editMessage(messageId, oldText) {
                this.ui.userInput.value = oldText;
                this.methods.autoExpand(this.ui.userInput);
                this.methods.validateInput();
                this.ui.userInput.focus();
                const userMsgElement = document.getElementById(messageId);
                if (userMsgElement) {
                    const aiMsgElement = userMsgElement.nextElementSibling;
                    userMsgElement.remove();
                    if (aiMsgElement) aiMsgElement.remove();
                }
                this.state.chatHistory = []; // Clears history to restart this thread
                this.methods.saveAllChats();
            },
            regenerateResponse(modelMessageId) {
                const modelMsgElement = document.getElementById(modelMessageId);
                if (!modelMsgElement) return;

                const userMsgElement = modelMsgElement.previousElementSibling;
                if (!userMsgElement || !userMsgElement.querySelector('.chat-bubble-user')) {
                    this.methods.addMessage('system', 'Cannot regenerate. The original user query is missing.');
                    return;
                }
                const userText = userMsgElement.querySelector('.message-text-content').textContent.trim();
                
                modelMsgElement.remove();

                if (this.state.chatHistory.length > 0 && this.state.chatHistory[this.state.chatHistory.length - 1].role === 'model') {
                    this.state.chatHistory.pop();
                }
                
                this.methods.addMessage('system', 'Regenerating response...');
                this.methods.sendMessage(userText, true);
            },
            deleteMessage(messageId) {
                const elementToDelete = document.getElementById(messageId);
                if (!elementToDelete) return;
                const isUserMessage = elementToDelete.classList.contains('user-message-wrapper');
                const aiMsgElement = isUserMessage ? elementToDelete.nextElementSibling : null;
                elementToDelete.remove();
                if (aiMsgElement && aiMsgElement.classList.contains('ai-message-wrapper')) {
                    aiMsgElement.remove();
                }
                
                const remainingMessages = Array.from(this.ui.chatWindow.querySelectorAll('.user-message-wrapper, .ai-message-wrapper')).map(el => {
                    const isUser = el.classList.contains('user-message-wrapper');
                    const textContent = el.querySelector('.message-text-content').textContent.trim();
                    const timeEl = el.querySelector('.timestamp');
                    const time = timeEl ? timeEl.textContent : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    return { 
                        role: isUser ? 'user' : 'model', 
                        text: textContent, 
                        time: time, 
                        parts: [{ text: textContent }] 
                    };
                });
                
                this.state.chatHistory = remainingMessages;
                this.methods.saveAllChats();
                
                if (this.ui.chatWindow.childElementCount === 0) {
                    this.methods.startNewChat();
                }
            },
            copyToClipboard(text) {
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    this.methods.addMessage('system', 'Text copied to clipboard.');
                } catch (err) {
                    console.error('Could not copy text: ', err);
                    this.methods.addMessage('system', 'Failed to copy text. Please try manually.');
                } finally {
                    document.body.removeChild(tempInput);
                }
            },

            // --- TTS UTILITY (REFACTORED FOR RELIABILITY) ---
            base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            },
            async listenToMessage(text) { 
                if (!this.state.audioContext) {
                    this.methods.addMessage('system', 'Audio playback is not supported on this browser.');
                    return;
                }

                if (this.state.audioContext.state === 'suspended') {
                    await this.state.audioContext.resume();
                }

                this.methods.addMessage('system', 'Generating audio...');
                const ttsUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${this.config.API_KEY}`;
                const payload = { 
                    contents: [{ parts: [{ text: `Say with a clear voice: ${text}` }] }], 
                    generationConfig: { 
                        responseModalities: ["AUDIO"], 
                        speechConfig: { 
                            voiceConfig: { 
                                prebuiltVoiceConfig: { voiceName: this.state.ttsVoice } 
                            } 
                        } 
                    } 
                };

                try {
                    const result = await this.methods.fetchWithRetry(ttsUrl, payload);
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        const match = mimeType.match(/rate=(\d+)/);
                        const sampleRate = match ? parseInt(match[1], 10) : 24000;
                        
                        const pcmBuffer = this.methods.base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmBuffer);

                        const pcm32 = new Float32Array(pcm16.length);
                        for (let i = 0; i < pcm16.length; i++) {
                            pcm32[i] = pcm16[i] / 32767;
                        }

                        const audioBuffer = this.state.audioContext.createBuffer(1, pcm32.length, sampleRate);
                        audioBuffer.copyToChannel(pcm32, 0);

                        const source = this.state.audioContext.createBufferSource();
                        source.buffer = audioBuffer;
                        source.connect(this.state.audioContext.destination);
                        source.start(0);

                    } else {
                        throw new Error("Invalid audio response format from API.");
                    }
                } catch (error) { 
                    console.error("TTS or playback failed:", error); 
                    this.methods.addMessage('system', 'Audio playback failed. Please check the console for details.'); 
                }
            },

            // --- AI RESPONSE STREAMING ---
            async streamResponse(text) {
                return new Promise(resolve => {
                    const aiMessageElement = this.methods.addMessage('model', [{text: ''}]);
                    const textContentDiv = aiMessageElement.querySelector('.message-text-content');
                    if (!textContentDiv) { resolve(); return; }

                    textContentDiv.innerHTML = '<span class="typing-cursor"></span>';
                    this.ui.chatWindow.scrollTop = this.ui.chatWindow.scrollHeight;

                    let i = 0;
                    const baseSpeed = 25; 
                    const speedVariation = 20;

                    const typeWriter = () => {
                        if (this.state.stopGenerationRequested || i >= text.length) {
                            const finalText = text.substring(0, i);
                            textContentDiv.innerHTML = this.methods.formatGeminiResponse(finalText);
                            
                            if (this.state.chatHistory.length > 0 && this.state.chatHistory[this.state.chatHistory.length - 1].role === 'model') {
                                this.state.chatHistory[this.state.chatHistory.length - 1].parts = [{ text: finalText }];
                            }
                            this.methods.saveAllChats();
                            
                            resolve();
                            return;
                        }

                        const char = text.charAt(i);
                        textContentDiv.innerHTML = text.substring(0, i + 1).replace(/\n/g, '<br>') + '<span class="typing-cursor"></span>';
                        this.ui.chatWindow.scrollTop = this.ui.chatWindow.scrollHeight;
                        i++;

                        let delay = baseSpeed + (Math.random() * speedVariation) - (speedVariation / 2);
                        if (char === ',' || char === '\n') delay += 200;
                        if (char === '.' || char === '?' || char === '!') delay += 350;
                        
                        setTimeout(typeWriter, delay);
                    };
                    
                    setTimeout(typeWriter, 400); 
                });
            },

            // --- CORE SEND LOGIC ---
            async sendMessage(overrideText, isRegenerate = false) {
                if (this.state.isGenerating) return;
                
                const userText = overrideText || this.ui.userInput.value.trim();
                if (!userText && !this.state.attachedFile) return;
                
                this.state.isGenerating = true;
                this.state.stopGenerationRequested = false;

                const messageParts = [];
                if (userText) {
                    messageParts.push({ text: userText });
                }
                
                if (this.state.attachedFile) {
                    messageParts.push({
                        inlineData: {
                            mimeType: this.state.attachedFile.type,
                            data: this.state.attachedFile.data
                        }
                    });
                }
                
                if (!isRegenerate) {
                    this.methods.addMessage('user', messageParts);
                    this.state.chatHistory.push({ role: 'user', parts: messageParts, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) });
                    if (this.state.chatHistory.length === 1) {
                         this.methods.saveAllChats(); 
                    }
                }
                
                this.ui.userInput.value = '';
                this.ui.userInput.style.height = 'auto';
                this.methods.removeAttachment();
                this.ui.sendButton.disabled = true;
                
                this.ui.loadingIndicator.classList.remove('hidden');
                this.ui.loadingMessage.textContent = "Knowsta is thinking...";
                this.ui.stopGeneratingBtn.classList.remove('hidden');
                this.methods.playSendSound();
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${this.config.FLASH_MODEL}:generateContent?key=${this.config.API_KEY}`;
                
                const personaPrompts = {
                    general: `You are Knowsta, an advanced and friendly conversational AI. Your primary goal is to provide **the absolute fastest, most concise, and highly relevant answer**. You MUST detect the language of the user's current query and respond in that same language. Adopt a **${this.state.responseTone}** tone and personality. Keep your responses short and well-structured using Markdown, including code blocks with language identifiers. Do not include unnecessary conversational filler or preamble.`,
                    marketing: `You are Knowsta, a world-class Marketing Strategist AI. Your expertise is in digital marketing, branding, copywriting, and market analysis. Provide actionable, creative, and data-driven marketing advice. Adopt a **${this.state.responseTone}** tone. Respond in the user's language. Be concise and use Markdown for clarity.`,
                    learn: `You are Knowsta, an expert educator and learning assistant AI. Your goal is to explain complex topics simply and clearly. Break down concepts, provide analogies, and use structured formats like lists and summaries to aid understanding. Adopt a **${this.state.responseTone}** and patient tone. Respond in the user's language.`,
                    coding: `You are Knowsta, an expert programmer AI and coding assistant. Your strengths are in writing clean, efficient code, debugging, explaining algorithms, and software architecture. Always provide code in formatted Markdown blocks with language identifiers. Explain the code clearly and concisely. Adopt a **${this.state.responseTone}** and technical tone. Respond in the user's language.`
                };

                const baseInstruction = `If the user asks about the creator, developer, or founder of Knowsta, you may provide the following information: ${this.config.CREATOR_BIO}`;
                const systemInstruction = (personaPrompts[this.state.activePersona] || personaPrompts['general']) + '\n' + baseInstruction;

                const apiHistory = this.state.chatHistory.map(msg => ({ 
                    role: msg.role === 'model' ? 'model' : 'user', 
                    parts: msg.parts 
                }));
                const payload = { contents: apiHistory, systemInstruction: { parts: [{ text: systemInstruction }] } };

                try {
                    const result = await this.methods.fetchWithRetry(apiUrl, payload);
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const aiResponseText = candidate.content.parts[0].text;
                        this.ui.loadingIndicator.classList.add('hidden');
                        this.ui.stopGeneratingBtn.classList.add('hidden');
                        
                        this.state.chatHistory.push({ role: 'model', parts: [{ text: aiResponseText }], time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) });
                        
                        await this.methods.streamResponse(aiResponseText);
                        this.methods.playReceiveSound();
                    } else {
                        throw new Error(result.error ? result.error.message : "Received a blank response.");
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    this.ui.loadingIndicator.classList.add('hidden');
                    this.ui.stopGeneratingBtn.classList.add('hidden');
                    this.methods.addMessage('system', `Network Error: I'm having trouble connecting. Details: ${error.message}. Please try again.`);
                } finally {
                    this.state.isGenerating = false;
                    this.state.stopGenerationRequested = false;
                    this.ui.loadingIndicator.classList.add('hidden');
                    this.ui.stopGeneratingBtn.classList.add('hidden');
                    this.methods.validateInput();
                    this.ui.userInput.focus();
                    this.methods.saveAllChats();
                }
            },
            
            // --- FILE/IMAGE METHODS ---
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64Data = e.target.result.split(',')[1];
                    this.state.attachedFile = {
                        name: file.name,
                        type: file.type,
                        data: base64Data,
                        previewUrl: e.target.result
                    };
                    this.methods.renderAttachmentPreview();
                    this.methods.validateInput();
                };
                reader.readAsDataURL(file);
                this.ui.fileInput.value = '';
            },
            renderAttachmentPreview() {
                if (!this.state.attachedFile) return;

                let previewHtml = '';
                if (this.state.attachedFile.type.startsWith('image/')) {
                    previewHtml = `<img src="${this.state.attachedFile.previewUrl}" class="max-h-20 w-auto rounded-md object-cover">`;
                } else {
                    previewHtml = `<div class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                        <span>${this.state.attachedFile.name}</span>
                    </div>`;
                }

                this.ui.attachmentPreview.innerHTML = `
                    <div class="flex items-center justify-between">
                        ${previewHtml}
                        <button onclick="knowstaApp.methods.removeAttachment()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>`;
                this.ui.attachmentPreview.classList.remove('hidden');
            },
            removeAttachment() {
                this.state.attachedFile = null;
                this.ui.attachmentPreview.classList.add('hidden');
                this.ui.attachmentPreview.innerHTML = '';
                this.methods.validateInput();
            },


            // --- ADVANCED METHODS ---
            renderChatHistoryList() {
                this.ui.chatHistoryList.innerHTML = '';
                const chatIds = Object.keys(this.state.allChats).reverse();
                if (chatIds.length === 0) {
                    this.ui.chatHistoryList.innerHTML = '<p class="text-xs text-gray-400 px-1">No recent chats.</p>';
                    return;
                }

                chatIds.forEach(chatId => {
                    const chat = this.state.allChats[chatId];
                    if (chat.length > 0) {
                        const firstUserMessage = chat.find(m => m.role === 'user');
                        const textPart = firstUserMessage?.parts?.find(p => p.text);
                        const title = textPart ? textPart.text.substring(0, 25) + (textPart.text.length > 25 ? '...' : '') : 'Chat with media';
                        
                        const item = document.createElement('div');
                        item.className = `chat-history-item text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/50`;
                        if (chatId === this.state.currentChatId) {
                            item.classList.add('active');
                        }

                        const titleSpan = document.createElement('span');
                        titleSpan.className = 'chat-title';
                        titleSpan.textContent = title;
                        titleSpan.onclick = () => this.methods.loadChat(chatId);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-chat-btn text-gray-400 hover:text-red-500';
                        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.methods.deleteChat(chatId);
                        };

                        item.appendChild(titleSpan);
                        item.appendChild(deleteBtn);
                        this.ui.chatHistoryList.appendChild(item);
                    }
                });
            },
            clearAllData() {
                localStorage.removeItem(this.methods.getChatsKey(this.state.userId));
                localStorage.removeItem(this.methods.getProfileBioKey(this.state.userId));
                localStorage.removeItem(this.config.VOICE_KEY);
                this.state.allChats = {};
                this.state.currentChatId = null;
                this.methods.startNewChat();
                this.methods.hideSettingsModal();
                this.methods.addMessage('system', 'All your local data has been cleared.');
            },
            deleteChat(chatId) {
                delete this.state.allChats[chatId];
                if (this.state.currentChatId === chatId) {
                    const remainingChats = Object.keys(this.state.allChats);
                    if(remainingChats.length > 0) {
                        this.methods.loadChat(remainingChats[remainingChats.length - 1]);
                    } else {
                        this.methods.startNewChat();
                    }
                }
                this.methods.saveAllChats();
            },
            stopGeneration() {
                if (this.state.isGenerating) {
                    this.state.stopGenerationRequested = true;
                }
            }
        };

        // --- GLOBAL INITIALIZATION ---
        window.knowstaApp = knowstaApp;
        document.addEventListener('DOMContentLoaded', () => knowstaApp.init());

    </script>
</body>
</html>

